# Continuum limit and preconditioned Langevin sampling of the path integral molecular dynamics

## 1 Introduction



Simulating complex chemical systems including quantum effects has been one of the central research subjects in computational chemistry and physics. For the thermal average calculation, the ring polymer representa- tion, based on the imaginary time path integral, has been a popular approach to map a quantum particle in thermal equilibrium to a fictitious classical necklace of beads on the phase space [19]. As the number of beads in the ring polymer goes to infinity, the representation is asymptotically exact, and thus it provides an approximate formulation for numerical simulations when the bead number is large. Based on the ring poly- mer representation, there are mainly two types of sampling techniques to calculate the quantum statistical averages, namely, path integral Monte Carlo (PIMC) [12, 1] and path integral molecular dynamics (PIMD) [40, 10]. Also, the ring polymer representation has been used in the dynamics simulations, such as, the centroid molecular dynamics [7, 6, 28], the ring polymer molecular dynamics [14, 21], Matsubara dynamics [26, 27], and path integral Liouville dynamics [33, 35]. In recent years, the ring polymer representation based methods, like path integral molecular dynamics, have been extended to the multi-level systems when the non-adiabatic effects are not negligible [42, 45, 46, 37, 36, 38].

When the number of beads is finite, the ring polymer representation introduces quantifiable asymptotic error to thermal average calculations, which is manifested in the bias of the numerical simulations. When

*Department of Mathematics, Department of Physics and Department of Chemistry, Duke University, Durham NC 27708, USA

+ Department of Mathematics, Duke University, Durham NC 27708, USA

#Beijing International Center of Mathematical Research, Peking University, Beijing 100871, P.R. China

1

the physical space of the quantum particle is high dimensional, when the inverse temperature is large, or when the potential landscape is complicated, a large number of beads are needed to decrease the model error. However, as the number of beads increases, the spring potential for the ring polymer becomes more stiff, which brings additional challenges for numerical sampling. More precisely, the highest frequency of the normal modes of the ring polymer increases as as the number of beads increases, which restricts the time steps for the numerical integration of the sample trajectory.

Improved numerical approaches based on the ring polymer representation have received much attention. Efficient sampling techniques are introduced by decomposing the potential function or by exploring ther- mostatting methods, see e.g., [20, 8, 40, 10, 9, 11, 34, 30]. It is also proposed to adjust the artificial masses for the momentum variables in the path integral representation to improve the numerical efficiency in the framework of normal modes or staging coordinates, see e.g., [48, 5, 15, 40, 34]. More recently, there are also some attempts by making use of the Matsubata modes, which can be viewed as the finite dimensional ap- proximation to the limit that the number of beads goes to infinity [41, 26, 27]. We also remark that previous works mostly focus on finite number of modes without considering the infinite dimensional limit of the Gibbs measure in the path integral representation, and thus the understanding of the improving techniques above are limited to the finite dimensional cases.

In this work, we focus on the thermal averages defined in the following form

(Â)= = Tr[e-BÎÂ],

where H is a quantum Hamiltonian operator, A is an observable, 8 is the inverse temperature, and Z = Tr[e-BH] is the partition function.

Formally speaking, when the number of beads goes to infinity, the ring polymer converges to a (closed) Brownian path in the configuration space such that the two ends agree. This continuum limit has been studied in math literature, where the closed Brownian paths are referred to as Brownian loops (see e.g., [22], where the motion of the random loops on a Riemannian manifold is considered). In our current context, we define the space of all loops on the Euclidean space Rd, denoted by CRd, as

CIRd := {q : [0, 3] -> Rd, q(0) = q(3)}.

The energy of the loop q E CRd is given by

00 E() = 50-a(+)12 + V(+) dr.

(1)

We emphasize that the inverse temperature appears in the integration limit in the definition of the loop energy (1). On the loop space CRd, we formally define the (infinite dimensional) Gibbs probability measure T on the loop space by

T(dq) x exp(-E(q)) D[q],

where D[q] is a flat reference measure on the loop space. Of course this picture is not rigorous since there is no Lebesgue measure in a infinite dimensional space. Nevertheless, this is rigorous at the level of finite dimensional distribution and a proper definition of T is given in Section 2.1 by taking a Gaussian measure

2

as the reference measure. With the measure T formally defined as above, we have

(A) = Er(da) A ( T ) dT

L

= 1

·ß A(q(T)) dr e-E(4) D[q] = BZ 1

0

(2)

·ß

A(q(T)) dr

0 X e - Jo } |0+ q(+)|2+V (q(+) df D[g],

which is the Euclidean path integral representation of the quantum thermal average. We emphasize again that the partition function 2 is not properly defined here since D[q] is not well-defined; see (6) for the definition in the finite dimensional case.

To sample the measure T on the path space, one can generalize the conventional overdamped Langevin equation to the following stochastic partial differential equation (SPDE)

dt dq = 8E(q) §q + $ = 87-9 - VV (q) + §, −

which produces ergodic path of loops with respect to T. Here, we use T to denote the parametrization variable of the path and denote by § the space-time white noise. This SPDE can be viewed as a continuum limit of the overdamped Langevin equation of ring polymers with finite number of beads.

While to the best of our knowledge, the perspective of loop sampling has not been much explored in the context of PIMD, it is closely related to the question of sampling diffusion bridges (Brownian paths with fixed boundary conditions) in applied mathematics and statistics literature, e.g., [25, 24]. In particular, efficient numerical algorithms for sampling the diffusion bridges have been extensively studied in the past decade, see e.g., [3, 2, 23, 17]. In particular preconditioning of the infinite-dimensional SPDE have been explored to improve the sampling efficiency, see e.g. [13, 4, 31, 2, 43].

Motivated by the similarity between PIMD and diffusion bridge sampling, in this work, we study the continuum limit of PIMD when the number of bead goes to infinity. Based on the analytic understanding, we propose two preconditioned Langevin sampling dynamics, both motivated by recent techniques proposed in the context of diffusion bridge sampling. Our first preconditioning approach is based on the idea of applying the covariance operator as in [24, 3, 23, 43]. After applying the covariance operator properly in the context of PIMD, the frequencies of the normal modes of the preconditioned Langevin dynamics have a uniform upper bound with respect to the bead number. In particular, the more important modes are mapped to the ones closer to the upper bound such that those modes are favored in sampling. Secondly, inspired by the treatments on the phase space as in [2] and [43], we propose a mass-modified Langevin dynamics, where the frequencies of all normal modes are adjusted to 1 in the harmonic case. Such mass-modified Langevin dynamics naturally connects to their continuum limit, the SPDEs on the phase space, and can be reformulated to facilitate constructing efficient numerical algorithms. In addition, we prove in the harmonic case that the law of the preconditioned SPDEs converges to the equilibrium measure exponentially with an explicit rate.

We emphasize that studying the continuum limit of the sampling measure and preconditioning techniques for the sampling equations in the infinite dimensional limit naturally give their finite dimensional counter- parts. The subtle paradigm shift lies in that while most previous works study the preconditioning in the large but finite dimensional cases, we make use of the continuum limit to guide us in designing precondi- tioned sampling dynamics. Thus, we expect the proposed sampling equations to exhibit uniformly satisfying performances with respect to the number of beads.

3

For finite dimensional systems, the techniques boil down to regularizing the spring potential with a constable multiple of the quadratic potential and applying its inverse to precondition the sampling dynamics. The proposed preconditioning strategy can be easily extended to the multi-level quantum systems, where the nonadianatic interplay between the electronic energy levels is present.

To sum up, we propose two preconditioned Langevin dynamics, which are shown to have superior nu- merical performances in stability and sampling accuracy. The rest of the paper is outlined as follows. We study the continuum limit of the ring polymer approximation in position variables in Section 2.1, and the continuum limit of the overdamped Langevin dynamics and its preconditioned version are introduced in Sec- tion 2.2. In Section 2.3, two preconditioned underdamped Langevin dynamics are proposed with different choices of mass matrices of the auxiliary momentum variables, where the latter one is shown to connect with the continuum limit of the Gibbs measure on the phase space. The two preconditioned Langevin dynamics are further analyzed and compared with the normal mode representation, the staging coordinate representa- tion, and the Matsubara representation in Section 3.1 and Section 3.2. The convergence to the equilibrium of the preconditioned SPDEs in the harmonic case is proved in Section 3.3. In Section 4, we discuss the preconditioning techniques for the multi-level quantum systems. Finally, in Section 5, we discuss the minor modifications in numerical implementations, and provide extensive numerical tests.

## 2 Continuum limit of the ring polymer representation



In this section, we investigate the continuum limit of the ring polymer representation, as the number of beads goes to infinity. We also study the continuum limits of the overdamped and underdamped Langevin sampling schemes for the ring polymer configurations. The preconditioning methods will be introduced to overcome the stiffness of the dynamics when the number of beads is large. As we will consider the continuum limit, to distinguish, we will use regular font (such as q) for position configuration in Rd for one bead, bold fonts such as q for the ring polymer with finite beads, and Fraktur fonts such as q for the continuous path.

## 2.1 Path integral for thermal average



Let us consider the quantum Hamiltonian

Î=Î+V="++V(@),

where the particle mass is fixed as 1 for simplicity of notation. We consider the thermal equilibrium average, given by

(3)

1 (Â) = = Tr[e-BÎÂ] for an observable A, where 6 = 1, with kB the Boltzmann constant and T the absolute temperature.

The ring polymer representation approximates the thermal average as (up to a normalization) an average with respect to the classical Gibbs distribution for ring polymers on the configurational space as

1 EN JRON

-

1 N NA(di)e -SN(q) dq + O(N-2),

(Â) =

(4)

i=1

where N is the number of beads, the action is given by

B N (qi - qi+1)2 SN (q) = N

2(B/N)2 + V(qi)]

,

(5)

i=1

4

and Zy is a normalization constant

(6)

ZN = | İRAN

e-SN (q) dq,

so that

duN (q) = ZN 1 - exp(-SN (q)) dq is a probability measure on the ring-polymer configurations.

Sufficiently large number of beads N is needed to reduce the asymptotic error in the ring polymer representation. However, a large N increases the stiffness associated to the "spring potential" in the action: ≥(*) (qi - qi+1)2. In particular, as illustrated in Figure 1, as the number of beads increases, a typical ring polymer configuration exhibits small scale oscillations. In the limit N -> co, it converges to random loops with local regularity similar to a Brownian motion.

N=16

N=32

N=64

N=128

Figure 1: Illustrative plots of ring polymers as the number of beads increases, made by initializing the beads evenly along a circle and numerically evolve the beads for a tiny time period using the Langevin dynamics (Lang).

The ring polymer configuration, in the limit N > co, can be represented as a path q(7) : [0, 3] > Rd with periodic boundary condition q(0) = q(6). From the ring polymer configuration with N beads, we may construct a corresponding path by setting q(Tj) = qj for Tj = B& and linearly interpolating in between. As N > co, we obtain

SN (q) -> β [|q ( 7) 12 2 + V(q(T)) |dT

- 0

and

i=1 NA (gi) A ( +) dr .

Thus the path integral representation (2) is formally justified in the limit.

To make the characterization of the limit N -> co more rigorous, note that we can interpret UN as

duN (q) x exp(- β N i=1 N EV (qi) ) dUN (q)

5

where UN is the finite dimensional Gaussian measure given by the harmonic spring potential part of SN

dvN (q) x exp 2N 1 3 i=1 1 3 (B/N)2 (qi - qi+1)2) dq

= exp 2 N q . Lq) dq.

N

(7)

Here the last equality gives the definition of L as a dN × dN dimensional positive semi-definite matrix, with its lowest eigenvalue being 0, associated with the eigenvector that all qi's are equal, so that the spring potential takes value 0.

To move the spectrum of L away from 0, we introduce for a fixed a > 0

La = L + QI,

(8)

where I E RaNxdN denotes the identify matrix. To see why this shift is used, observe that due to the existence of the zero frequency mode, the measure UN (q) corresponding to the spring potential +q · Lq is not normalizable even in the finite dimensional cases. Adding the extra harmonic trapping potential makes the shifted spring potential +q . Laq grow quadratically at infinity. We will see below that with this shift the corresponding measure as well as its infinite dimensional limit are properly defined.

Note that L can be viewed as a second order finite difference approximation to the operator -A with the periodic boundary condition for an equidistant partition of the interval [0, 3]. Thus as N > 00, La converges to the differential operator

## £a = (-8++ + a) Id



(9)

with periodic boundary conditions and Id is the identity operator from Rd to Rd.

In terms of La, we define a new Gaussian measure

dug(q) x exp ( -~ ~ q . Laq) dq,

and we can rewrite the measure UN as

duN (q) o exp(- N i=1

N EUª (gi) ) du& (q)

β

(10)

with U(g) = V(q) - 2|q|2, which we assume to grow to infinite as |q| > > (with a chosen sufficiently small). As N -> oo, we have

q.Laq >|09(7)|2+al (+)2 dr

and correspondingly the Gaussian measure v& converges to a well-defined infinite dimensional Gaussian measure vª with mean 0 and covariance operator given by @* = (Sa)-1. The infinite dimensional limit of UN is given therefore by

du x exp(- va(+) dr) dva α exp(- (V(q(T) - 11q(7)(2) dr ) dua.

(11)

In particular, the measure u is absolutely continuous with respect to the reference measure vª. Thus, we have

(A) = EM [+] [A (T) dT

6

=2-18 (+) ar 1 [A(+) dr va (dq).

This gives a rigorous path integral representation of the thermal average for quantum systems. To approx- imate (A), it thus suffices to construct some ergodic sampling schemes for the distribution u on the path space, which we discuss next.

## 2.2 Overdamped Langevin sampling



We now consider the overdamped Langevin sampling for ring-polymers, and the continuum limit. We will then introduce the preconditioning techniques to the continuum limit of the sampling equation. Those techniques have been extensively used for efficient sampling of diffusion bridges as in e.g., [25, 24, 3, 2], but to our best knowledge, not for sampling of random loops arising from the path integral representation.

Recall that the probability distribution UN can be sampled using the overdamped Langevin dynamics dq = (-Lq - VqVN) dt + V 2 dB BN

(12)

= (-Laq - VqUN) dt +V BN

2 .dB.

where we have used the short-hand notations BN = B/N, VN (q) = >i=1 V(qi), Ug(q) = == 1 Ua(qi), and B is an RdN dimensional Brownian motion with independent components. We observe that when N >> 1, the forcing term from the spring potential becomes quite stiff, which prevents the use of large time steps in numerical integration of the sampling trajectory. The restriction becomes more severe as the number of bead increases, and thus some preconditioning treatments are desired to enhance sampling efficiency by allowing the use of large time steps.

To gain insights for the design of the preconditioner, let us consider the most difficult scenario as the limit N > co, where the Langevin dynamics converges to the following stochastic partial differential equation (SPDE)

= - Sª q dt - VUª (q) dt + v2 dw, dq = arrqdt - VV (q) dt + v2 dw

(13)

with periodic boundary conditions in T and dw denotes the space-time white noise. Here, with slight abuse of notations, q(t) : R+ -> CRd is the trajectory of loops in the configuration space Rd, where t is viewed as the temporal variable for the trajectory and T is the parameter for the loops. The SPDE samples loops, the continuum analog of ring polymers as N > co, with the invariant measure given by u, the infinite dimensional limit of UN.

The reason to consider the continuum limit is that the overdamped Langevin equation (12) can be viewed as a finite dimensional approximation of the SPDE (13). Thus, the preconditioning techniques for the SPDE will shed light on the choice of preconditioner for the overdamped Langevin equations. In particular, as the stiffness comes from the differential operator S", a natural idea is to precondition the SPDE using the inverse of Sa, namely,

dq(t,T) = - qdt - (§ª)-1VU(q)dt+v2(Ca)-1dw.

(14) Similar preconditioners have been used for diffusion bridge sampling, see e.g., [25, 24]. For finite number of beads, the natural analog of such strategy is to precondition the overdamped Langevin equation (12) with the inverse of La. Hence the preconditioned equation is given by

dq = (-q-(La)-1VqU@) dt + 1 BN 2(La)-1

dB.

(15)

7

It is easy to check that the preconditioned equation takes the same invariant measure, while the stiff term Lª q is now replaced by a linear damping term, which is much easier to handle numerically. For completeness, the inverse of Sa and its finite dimensional approximation are discussed in Appendix A.

For ring polymer representation, compared with the overdamped sampling, sampling using the under- damped Langevin dynamics is more efficient and hence much more popular, see e.g., [10, 34]. The precon- ditioning strategy in the overdamped case discussed can be extended to the underdamped case.

## 2.3 Underdamped Langevin sampling



Let us now consider the preconditioning of underdamped Langevin sampling of ring-polymers, again by the view point of taking the continuum limit. For path-integral molecular dynamics, auxiliary momentum variables with artificial masses are introduced to improve the sampling efficiency. In the augmented state space of position and momentum of ring polymer beads, the thermal average is given by

(Â) = [. RdNxRdN

1 N N A(qi) TN (dq dp) + O(N-2), (16)

L i=1

with the Gibbs distribution

1 E'N e-BN HN (q,P) dq dp (17)

TIN (dq dp) =

and the Hamiltonian

HN(q,p)= >p . M-1p+2 N 2B'2 qi - qi+1|2

+ V (qi)

i=1 1

(18)

= 2p . M-1p + -q . Laq + UN(q),

where q = (q1, ... , qN) and p = (p1, ... , PN) are the position and momentum of the beads with the convention qN+1 = 91, and Zy is the normalization constant of the probability distribution TIN. In the Hamiltonian, M is a positive definite fictitious mass matrix for the auxiliary momentum variables p, which should not be confused with the physical mass of the quantum particles (which has been chosen to be 1 from the beginning).

It is clear from the definition that the distribution TIN takes a product form

TIN (dq dp) = 1 (e-BN SN (q) da) (e-2 p.M-1p dp). (19)

EN

In particular, the marginal distribution with respect to q, which agress with UN, is independent of the choice of the fictitious mass matrix M, as long as it is positive definite. Thus many choices can be made for the benefit of sampling efficiency. One common choice in the literature of path-integral molecular dynamics is to take M a constant multiple of the identity matrix M = mI, where m is a scalar, see e.g., [21]. With this choice, we obtain the following Langevin equation associated with the Hamiltonian (18),

dq = P dt;

m

dp = - Lqdt - VqVN dtyp dt + 1 BN 27m &B,

(Lang)

where y > 0 is the friction parameter and B denotes a vector of dN independent Brownian motion. Diagonal mass matrix with variable entries have also been explored to adjust the mode frequencies [48, 5]. We will compare the Langevin equation (Lang) with its variants introduced in the sequel.

8

When the number of beads N is large, the forcing - Lq becomes stiff which prevents the use of large time steps in numerically integrating (Lang) (in fact, as N -> 00, the allowed time step size decreases to 0). This can be seen as in the Hamiltonian dynamics, q(t) consists of both O(1) and high frequency modes, with the latter induced by the stiff spring potential between the beads. Preconditioning of (Lang) is thus required when N >> 1 for efficient sampling.

Using La and Uª, the momentum part of (Lang) can be rewritten as

dp = - Laq dt - VqUN dt - ypdt + 1 V BN 2ym -dB.

(20)

Therefore, similar to what has been done in the overdamped case, we may use (La)-1 to precondition the system. It is straight-forward to verify that the following preconditioned Langevin equation samples the same invariant measure TIN (for completeness, a derivation is given in Appendix B):

dq = - (La)-1pdt;

dp= - qdt - (La)-1VQU& dt - y(La)-1pdt + 1 dB. BN 2ym(L)-1 (pLang)

However, taking the mass matrix as a scalar multiple of the identity matrix has issues when N > co. In that case the distribution TIN as in (19) does not have a limit, since the momentum part of the resulting measure is not normalizable. On the other hand, the limit of AN, the marginal distribution in q, does exist and is given by u. As a result, the limiting process of (pLang) is not well defined and we may encounter trouble when using the dynamics (pLang) to sample for large N.

This issue can be overcome by a proper choice of the mass matrix. Recall that after all the choice is arbitrary for finite dimensional systems as long as the mass matrix is positive definite. In particular, inspired by the work [2] which considers hybrid Monte Carlo methods in infinite dimension, we make the choice M = La, which leads to the following mass-modified Langevin (mmLang) dynamics

dq = (La)-1pdt;

dp = - La q dt - VqUN dt - ypdt + BN 2yLa d.B. (mmLang)

The choice of the mass matrix M = La is made, since after a change of variable, it leads to a sampling measure with well-defined infinite dimensional limit; and also gives rise to a preconditioned Langevine dynamics with superior properties Let us multiply the momentum part of (mmLang) by (La)-1 and further introduce the velocity variable v = M-1p = (La)-1p, we obtain the preconditioned mass-modified Langevin (pmmLang) dynamics

dq = v dt;

(pmmLang)

dv = - qdt - (La) -10 qUN dt - yv dt + BN 2~(La)-1

d.B.

In the limit N > >, the system (pmmLang) converges to the following SPDE

dq(t,T) = bdt;

du(t, T) = - qdt - @VqUR dt - yodt + 2yea dw,

(21)

where dw is the space-time white noise, and thus veª dw is the cylindrical @@-Wiener process in probability terms (see e.g., [16, 22]). Under some technical assumptions on V, it can be proved that the phase space

9

distribution

TN(q, v) x exp (-BNSN(q)) exp (-BN -V . Lav)

converges to a well defined probability distribution T'as N > co, with marginal distribution udq. Moreover, the the SPDE system (21) takes T'(dq do) as the invariant measure. We will not go into the details here.

To conclude this section, we remark that both (pLang) and (pmmLang) have preconditioned the under- damped Langevin dynamics: in either system, the stiff forcing term Laq is replaced by a linear damping force term. However, only (pmmLang) has a well-defined continuum limit as the number of beads goes to infinity. We shall study their numerical performances in Section 5 when large number of beads are needed.

## 3 Normal modes analysis and Convergence in the continuum limit



In this section we compare our preconditioning approaches with the more familiar normal modes, staging coordinates and Matsubara modes in the literature of path integral molecular dynamics. Since those repre- sentations are introduced mostly for the Hamiltonian part (but not the thermostating such as Langevin), we will compare them with the proposed approach in the context of the Hamiltonian dynamics. Also, we show that when the potential is quadratic, the continuum limit of (pmmLang) system converges exponentially fast to its invariant measure, which implies that the (pmmLang) system converges to the invariant measure exponentially with a convergence rate that is independent of the system size.

## 3.1 Normal modes, staging coordinates and preconditioning



Recall that with the artificial mass matrix M, the Hamiltonian in PIMD is given by

=: Ha + UN, HN = 2p . M-1p+ -q . Lq + VN(q)

(22)

where Ha = +p . M-1p++q . Laq is the harmonic part. The corresponding Hamiltonian dynamics is given by

q = M-1p;

d +p = - Lq - VqVN (q) = - Laq - VqUN (q).

(23)

Let us introduce the normal modes (Pk, Qk) given by (we assume N is odd to simplify the algebra)

N N Pk= >pj Djk and qk = > qj Djk, k= 0, +1, ... , #- 2 ,

j=1

j=1 with the transformation matrix defined as

- 1/N, k =0,

Djk = 2/N sin(27 2 / N cos (2Tjk) N), -N-1 ≤k < 0.

2Tjk ), 0 < < < N-1

It is easy to check that D is an orthogonal matrix, hence the inverse transform is given by

(N-1)/2 k =- (N-1)/2 2 DjkIk.

Pj = (N-1)/2

k =- (N-1)/2 DjkPk, qj =

10

Using matrix notations, we have

q = DT q, p = DTp, and q = Dq, p = Dp.

In the normal mode representation, when the mass matrix is chosen as M = mI, HN can be written as

(N-1)/2 M

PĹ 2m

HN(q, p) = k =- (N-1)/2

+ 1 2

WROTE + VING

where

2 BN N l=1 ÎN(q)=>V -

WK = sin

KT

N ,

(N-1)/2 DjkÃk).

k =- (N-1)/2 1

In particular, we observe that wo = 0, which is consistent with the fact that the L matrix has the lowest eigenvalue 0. The corresponding spatial variable

18

1 N 1

j=1 N

is the centroid of the ring polymer. In Hamiltonian dynamics, the spring potential vanishes for the centroid mode, and the associated momentum changes according to the averaged force due to the external potential TTO - LÃO, d 12 dt 1 N ′

V j=1 N

The force from the spring potential shows up in momentum equation for the rest of the normal modes, which becomes dominant when |k| is large.

The Hamiltonian dynamics of normal modes reads

dt da=1p;

m atp = - DT LDq - DT VaV (Da)

(24)

= - DT La Dã - DT VaUN (Da).

The choice of D ensures that DT LD is a diagonal matrix with entries wz, and also DTLª D is a diagonal matrix with entries w2 + a. Therefore, with the use of the normal modes, the stiff part of the Hamiltonian dynamics, namely Lq, is diagonalized. This of course facilitates the design of accurate numerical scheme, but it does not, however, reduce the stiffness of the dynamics, because DT LD and L share the same eigenvalues. When the dimension is large, the fast modes lead to severe stability constraints which prevent efficient sampling.

With the normal mode transformation, we obtain that the harmonic part of the original Hamiltonian (i.e., when we neglect Ua) contains modes with frequency from va/m to O(N). We remark that, the diagonal mass matrix with variable components have been considered in previous works to tune the frequencies of the normal modes (see e.g. [5]), but centroid mode is treated differently from the rest of the normal modes since the spring potential vanishes for that mode. In particular, when k # 0, the masses of the normal modes can be chosen such that effectively those modes have the same frequency.

11

The staging coordinates (uk) for the position variables (qk) introduced in [48] lead to another useful transformation in the ring polymer representation, which is given by

U1 =91, Uk = 9k - k (k-1)qk+1 + q1 ,

k = 2, . . . , N. (25)

The inverse transform is

N

q1 = u1, qk = U1 + k'=k

Uk', k - 1 k-1

k = 2, ... , N.

(26)

With matrix notations, we have

## u = Diq, q = D2u = (D1)-1u,



where the transform matrices are defined according to (25) and (26) respectively. With the staging coordi- nates, the Hamiltonian can be rewritten as

N 2mk ₹2 + V (qk(u)) + D k=2 N

N

HN = k=1

1 2

~- 1

= o . M v + 1

mk 2 k

(27)

N

N -u . Mu + V (qk (u). k=1

Here, mk = k-1 k- for k = 2, ... , N, Uk are the auxiliary momentum variables for the staging coordinates, and mk > 0 are artificial masses to be prescribed. The M matrix is a diagonal matrix with mk as components, and M is also diagonal with 0 as the first component and mk for the rest. Note that the staging transform diagonalize the spring potential in the following sense

β N 1 2 -M = D1LD2 = D1L(D1)-1.

The associated Hamiltonian dynamics of the harmonic part are given by (i.e. dropping V)

(28)

2-1 du =M õ; 12

v ˜ = 1

dt d

Mu.

2

(29)

N

We observe that, the spring potential vanishes for the first staging variable u1, and the harmonic part of the Hamiltonian all have O(N) frequency except for the first mode. Similar to the normal mode representation, authors in [48, 5, 34] proposed to use the artificial mass matrix M to adjust all the modes except the first one to the same frequency. This is be achieved simply by choosing mk = mk for k = 2, ... , n.

Note that, the auxiliary momentum variables ~ for the staging variables u are not the same as the momentum variables p for the (Cartesian) position variables q. To find the connections, we first multiply (29) from the left by D2, and we get

4D20 = - Lq.

By comparing with the harmonic part of (23), this equations implies the connection between ~ and p,

D20 = p.

And with this change of variable, if we multiply (28) from the left by D2, we get

atq = (D2MD1)-1p.

12

This shows, the staging coordinates actually implies choosing a non-diagonal mass matrix Meff, which is given by

Meff = D2 MD1 = ByL + 1E1.

where E1 is a square matrix with the elements in the first column equal 1, and the rest of the elements are 0.

From the analysis above, we see that the system with the staging coordinate representation and the preconditioned mass-modified system introduced in Section 2.3 share a few common features: both can be viewed as choosing non-diagonal mass matrices which are accompanied by changes of variables, such that the harmonic part of the dynamics are diagonalized. But the choices of the mass matrices and the changes of variables are different, and unlike the preconditional mass-modified system, the staging representation leads to high frequency modes when BN << 1. We shall further compare those two approaches in terms of adjusting frequencies later in this section.

Let us now compare with the two proposed preconditioned dynamics (pLang) and (pmmLang).

The Hamiltonian part of the system (pLang) is given by

&q == (La)-1p;

(30)

d

afp = - q - (La)-1V qUN.

(31)

In the harmonic case that UR = 0, it reduces to

dt2q= -= (La)-1q.

Note that Lo has the smallest eigenvalue a, therefore (La)-1/m has the largest eigenvalue (am)-1 and the smallest eigenvalue (a+w2)m). Thus, with the help of the a-regularization, the frequency of the fastest mode has a uniform upper bound no matter how large N is. In other words, increasing the number of beads only adds more slow modes of the Hamiltonian system, which does not cause numerical stability constraints. Although the frequency ratio between the fastest mode and the slowest mode (i.e., condition number for the linear system) is not changed in the system (pLang): while it allows for larger step sizes, it also takes longer time for the slow modes to equilibrate. In terms of sampling, the system (pLang) is still superior to the system (Lang), since the low-frequency modes in (Lang) are more important for accurate approximation of the thermal average, which are mapped to the high-frequency modes in the system (pLang) with a uniform frequency upper bound (am)-1/2. In other words, the preconditioner in system (pLang) prioritize the modes which matter the most in sampling, at the prize of slowing the less important modes.

We next look at two mass modified Langevin systems. The Hamiltonian part of (mmLang) reads

## dq = (La)-1pdt; dp = - Laq dt - VqUN dt,



(32)

which reduces to a collection of independent oscillators with the same frequency in the harmonic case (Ua = 0)

d2 dt2 9 = - q.

(33)

The Hamiltonian part of (pmmLang)

d

q = vdt; dt (34) d -v = - qdt - (La)-1VqUN, (35)

dt

13

lead to the same oscillator equations (33) in the harmonic case (Ua = 0). Therefore, the harmonic part of the two Hamiltonians only contain unitary oscillations, regardless of the number of the beads N. The choice of the mass matrix M = La automatically adjusts all modes to the same frequency, so that the stability constraint is removed and at the same time greatly reduce the condition number. This is the main advantage of the choice of the mass matrix as La.

Compared with the normal mode representation and the staging coordinate representation, the mass matrix choice M = La (which is not a diagonal matrix) can help to adjust all mode to the same frequency 1 without any exception. We remark that, tuning all modes to the same frequency, however, is not sufficient for improved numerical stability. In fact, the harmonic part of the (mmLang) system also have uniform frequency, but as we shall see in Section 5.3, this system actually shows worse performances in terms of stability. The change of variable from p to v is also necessary in the preconditioning process. The essential difference between the (mmLang) system and the the (pmmLang) system is that the invariant measure of (q, v) for (pmmLang) does have a well-defined infinite dimensional limit, while the invariant measure of (q, p) for (mmLang) does not.

From another perspective, we can also understand the choice of the mass matrix M = La using the normal mode representation. Let us multiply the Hamiltonian system ( ?? )-(23) by DT from the left and get

dã = DT M-1 DỠ;

(36) d p = - DT LaDa - DTVQUa(Da).

(37)

Recall that DT LOD is a diagonal matrix with positive entries Ag = w2 + Q. To adjust all the normal modes to the same frequency, we require DTM-1D is also diagonal, and its diagonal entries are exactly (Ag)-1, namely, if Ua = 0,

Tk = ( dk ) - 1 Pk , TPk = - Ak Tk -

(38)

This clearly leads to the condition DTM-1D = (DT La D)-1, which results in the choice of the mass matrix M = La.

Then, to precondition the system (38), we introduce ~ = (\@)-1Pk, such that the Hamiltonian dynamics (38) reduces to dt az Tk = Ok, dt TTOk = - k-

In the matrix form, the change of variable becomes

₹ = DT (La)-1 Dã.

This gives

v = Dĩ = DDT (La)-1Dã = (La)-1q,

which recovers the choice of the velocity variable in (pmmLang).

## 3.2 Matsubara modes and the continuum limit



Let us now consider the Matsubara modes, introduced in [41, 26, 27]. We denote the Matsubara coordinates q = (GR), p = (Pk), k = - K-1, ... , K-1 (we take K as an odd number for simplicity). The Matsubara modes are defined to be the K lowest normal models in the ring polymer representation in the limit that the number of beads (and hence normal modes) goes to infinity. The Matsubara modes are thus expected to be connected to the continuum limit.

14

As is shown in [26], the effective Hamiltonian in the Matsubara coordinates is given by

1 p 2m 2 k + 2 + V K(q), ω 2 k q 2 k

HK =

M (K-1)/2

k =- (K-1)/2

where

2kT = N-100

Wk = β

VK(q) = lim 1

lim Wk,

N N l=1 k =- (K-1)/2 (K-1)/2 V √ N

M Dekąk).

Thus, the corresponding Hamiltonian dynamics reads

080

m 1

12

(39)

where A is a diagonal matrix with entries wk.

The Hamiltonian dynamics in the Matsubara modes can be viewed as a finite dimensional approximation of the continuum limit. For simplicity, we take the potential function V = 0 and the mass matrix M = mI, and similar to the previous analysis, the continuum limit of the Hamiltonian dynamic is given by 1 ∂ at q(t,T) == p(t,T);

op (+, T) = - &q(t, T) =

22

2- 29 (t, T).

(40)

The operator & with periodic boundary condition has eigenvalues

2

TK = (wk)2 = ( 2km ) , k = 0, 1, . .. ,

where To has one linearly independent eigenfunction, denoted by Po(T), and for k > 1, each Ak is associated with two linearly independent eigenfunctions, denoted by @+k(T). Thus, if we take the following finite dimensional approximation

q(t, T) = > k =- K' Kʹ Îk(t)Øk(T), p(t, T) ~ > K' k =- K' ₱k(t)Øk(T).

By orthogonality of the eigenfunctions, we obtain the ODE system for the coefficients

- n = 1- k,

분야 =- 지세요.

This system agrees with the Hamiltonian system in the Matsubara coordinates as in (39) when V = 0 and K' = K-1.

While a finite dimensional approximation as using the Matsubara modes reduces the stiffness of the system. The frequency of the Matsubara mode still ranges from 0 to @(K-1)/2. Thus, when K is chosen large to improve accuracy, it also brings in similar stability constraints.

To better compare the mode frequencies in different models, we plot in Figure 2 the distributions of the frequencies of the normal modes and the Matsubara modes, compared with the frequencies of the modes in

15

(the harmonic part of) the (pLang) and (pmmLang) systems. For the diagonal-mass preconditioned system (pLang), the use of (La)-1 as a preconditioner maps the the fast modes to the slow modes, while the upper bound of the mapped frequencies is independent of the number of beads. For the mass-modified system (pmmLang), all modes are mapped to unitary frequency. Hence, with those two preconditioning approaches, we no longer suffer stability constraints as the number of beads increases. Moreover, since the condition number is reduced to 1 for the (pmmLang), we expect the preconditioned mass-modified system works the best in sampling efficiency.



|10-2|10º|102|
|---|---|---|
|10-2|10º|102|
|10-2|100|102|
|10-2|100
:selected:|102|


## 3.3 Convergence of the (pmmLang) dynamics: the harmonic case



We have compared in the last section our preconditioning approaches with other existing preconditioning methods for the Hamiltonian dynamics. In the following, we switch gear back to the Langevin dynamics, and show that when the potential function is quadratic, the SPDE (21) converges to its invariant measure exponentially fast. We can also conclude from such analysis that the (pmmLang) system exponentially converges to its invariant measure with a rate that is independent of the bead number.

In the harmonic case (Ua = 0), the SPDE (21) reduces to

dq(t, T) = b dt;

do(t, T) = - q dt - 70dt + 12yCadw.

(41)

Formally, the invariant measure of the dynamics above is given by

II( dq, dp) = N(0,€*) × N(0, ca).

(42)

In the following, we aim to rigorously show that, the law L(q(t), b(t)) of the SPDE (41) converges to the invariant measure II exponentially fast with an explicit rate.

Theorem 3.1. Let L(q(t), (t)) be the law L(q(t), o(t)) of the SPDE (41) with zero initial condition. Then

W2(C(q(t), b(t), II) Se-0(t),

(43)

16

where the exponent 0(t) is given by

(t) = -

t - Int, r-Vy2 -4

0 < > < 2,

Y=2,

-t, It , 2

2

> > 2.

In (43), we use a ≤ b to denote that a ≤ Cb for some generic constant C which is independent of t and y.

Proof. We denote the eigen-pair of the covariance operator @@ by {j, Øj}jEN, i.e,

€‘j =X30j, j EN.

Recall that @@ is the inverse of Sa and they share eigenfunctions, and the eigenfunctions {0} } form a basis of a separable Hilbert space, which we denote by H. Then clearly @@ is a trace-class positive definite operator on H, and Vx E H, we have x = = 1 ªjoj.

Due to the completeness of the eigenfunctions {0} }, we write

00 j=1 q(t, T) = > ai(t)øj(T), b(t, T) = > vj (t)øj(T). j=1 00

Then we rewrite the SPDE (41) in terms of the evolution of the Fourier coefficients as follows

dqj = vj dt, dvj = - qj dt - yvj dt + 1/2yAj dWj.

(44)

Here {W;(t)} is a sequence of i.i.d one-dimensional Brownian motions. Note that the invariant measure of above is

:selected: Tj = Tq,j & Tv,j = N (0, 0',;) & N (0, 02,j)

with o2; = 02,; = x3.

Observe that the system for each Fourier coefficient pair (44) is linear, and thus we can solve the system analytically. Let us define the matrix

A = ( 1

1.

0 -1

We first consider the case when y2 < 4. And in this case, if we denote A = 72 - 4, then clearly A < 0, and the matrix A has two complex eigenvalues

H+ = - } +V-A 2 .

(45)

Moreover, A can be diagonized as

A = PAP-1 = ( 1

1 1 -

μ_ ) 1

-1

1) .

Setting (q'}, v'})T = P-1 (qj, Uj)T, we have

′ q dt + 21dj

j v';

dvʼ; ()=(14)

+ 1)"(,()

(46)

17

Note that, according to the assumption, the initial conditions for the coefficients (qj, Uj) are zeros, and thus the initial conditions for (q', v') are also zeros (otherwise the effect of the initial condition decays exponentially with rate y/2 anyway). And then the analytical solutions to (46) are given by

q'(t) =

iv-Ã Jo 21 |et+(t-s)dWj(s),

v';(t) = - V21dj iv-A J ·t el-(t-s) dWj(s). 0

Then, with (qj, Vj)T = P(q', v')T, we obtain the analytical solution to the equation of Fourier coefficients (44) with zero initial conditions,

q; (t) =212dj ft. 0 e-2(t-s) sin V-A(t-s)

2 dWj(s),

v; (t) = 1/211; ·t e-글(t-s) sin V-A(t- s) 2 dWj(s) (47)

V-A Jo t V-A(t-s) dW; (s).

+ 27dj e-글(t-s) cos

0

2

Clearly, qj(t) and vj(t) are mean-zero Gaussian random variable, and we denote their variances by Varq,j (t) and Varv,j (t), respectively.

By direct calculation, we get

87x2 Varq. (t) = Org /" e-t- -A cj,1 ===- (-7 cos(V-At) + V-A sin(V-At)

V-A (t-s)) 2 ) ds = X3 + 13e- vt cj,1.

(48)

where

,

and

Varv,j (t) = | e-y(t-s) (. 0 = 1,2 + 1,je- vt Cj,2,

1211; · sin V-4 2

V-A(t-s) +VEYA; cos ( 2 V-A(t-s) 2

ds (49)

where

4 Y(4-2~2) -44 (y cos (V-At) + V-A sin(V-At)

Cj,2 =~ +

+ 21-4 22 (ysin(V-At) + V-A cos(V-At)) .

Notice that, when t > +00, Varq,j > 12 and Varu,j > 12, and for fixed y, there exists a constant Cy, such that Vt > 0,

Cj,1 | < Cy, and |cj,2|< Cy.

This

Therefore, we have the following

2 W3 (N(0, Varq,j(t), Tq.j) = (VVarg.j(t) - Og.j) ≤|Varq.j(t) -02,il se~{x}cy.

And similarly, we obtain

W3(N(0, Varv,j(t), Tv,j) ≤e-rtx3cm.

18

The significance of the above estimates is, for each pair of Fourier coefficients, the convergence rate is independent of the mode index j. While by similar calculations, one can show that the Fourier coefficients of the (Lang) system and the (pLang) system have degenerate convergence rates as j > co.

Thus, by summing yo all Fourier coefficients, we obtain the following convergence estimate for L(q(t), b(t)),

W2(C(q(t), b(t), II) Se-2.

j

−

λ

2 j

e

2

.

(50)

We can carry out similar calculations for y > 2, when the matrix A has two distinct real negative eigenvalues, and the convergence estimate becomes

W2(L(q(t), b(t)), II) ≤ e

−

2 (1-V72 -4)t

.

(51)

Finally, when y = 2, the matrix A has two identical negative eigenvalues, and the the convergence estimate becomes

W2 (C(q(t), b(t), II) Se-tt.

(52)

This completes the proof.

:unselected:

Theorem 3.1 establishes the exponential convergence of the distribution of the SPDE (41) to its equi- librium measure, which implies that the finite dimensional system (pmmLang) converges to the invariant measure with a uniform rate. In contrast, for both the (Lang) system or the (pLang) system, one can show by similar calculations that the convergence rate becomes degenerate for high modes.

It is also worth to comment on the dependence of the convergence rate on the damping parameter y. When y € (0, 2), the convergence rate is increased as y increases. When y > 2, the convergence rate decreases as y increases. Observe also that when y > 1, the exponent 0(t) is approximately t/y, which is consistent with the fact that the Langevin dynamics converges to the overdamped limit under the time scaling t > yt as y > 00.

Finally, we remark that the exponential convergence result in Theorem 3.1 is expected to be generalized to a wider class of potential functions beyond the harmonic case. The recent works by Zimmer [49] and Bou-Rabee and Eberle [18] proved geometric ergodicity of a family of infinite-dimensional diffusions and the infinite dimensional preconditioned HMC based on a two-scale coupling approach. Similar ideas may be adopted to obtain a dimension-independent convergence rate for the preconditioned mass-modified Langevin dynamics (21) with a general potential. We will investigate this problem in a future work.

## 4 Preconditioned dynamics for multi-level systems



In the diabatic representation, the Hamiltonian operator of a general two-level system can be written as (atomic unit is used)

1 2 + (Vot 90

Voo (q) Vo1(@)) V10(q) V11(@)) ,

where q and p are the nuclear position and momentum operators, and the mass of the nuclei is chosen to be 1 (again, for simplicity we assume all nuclei have the same mass). The multi-level quantum systems arise when the non-adiabatic effect between different energy surfaces of electronic states cannot be neglected, see e.g., the review articles [39, 46, 29].

The thermal equilibrium average of observables, given by

(Â)= Trne[e-ßÎÂ Trne[e-ß}]

,

(53)

19

for an operator A, where B = 1 KBT with kp the Boltzmann constant and T the absolute temperature, and Trne denotes trace with respect to both the nuclear and electronic degrees of freedom, namely,

Trne = TIn Tre = Tr [2(Ra) TrC2 .

The denominator in (53) is the partition function given by Z = Trne[e-8}].

In [37, 36], it is shown that the thermal average can be viewed as (up to a normalization) an average with respect to the classical Gibbs distribution for ring polymers on the extended configuration space:

(A) =[ R2dN dq dp LE{0,1}N TIN (q, p, e)WN [A] (q, e), (54)

with the distribution

TIN (q, p, e) = 1 Z'N exp(-BN HN (q, p, e)). (55)

Here, the extended phase space variable (q, p, €) E R2dN x {0, 1}N, where q = (q1, ... , qN) are the position of each bead, p = (p1, ... , PN) are the momentum of each bead and l = ({1, ... , IN) indicates the energy level of the bead. The expressions for WN [A] and HN can be found in Appendix C, and the readers may also refer to [37] for detailed derivations. Similar to the single-level case, the Hamiltonian can be rewritten as

1 HN (q, p, e) = >p . M-1p + -q . Lq + VN (q, e)

(56)

= 2P . M- 1 'p + -q . Laq + UN (q, e).

Note that, the dependence on & is all contained in the VN (or equivalently, Uy ) part of the Hamiltonian. Ergodic trajectories with respect to the distribution (55) have been introduced in [37] to effectively sample in thermal averages in such two-level systems. In [36], the infinite swapping limit of the sampling path has been discussed to enhance the numerical performance of the algorithm when the observables have off-diagonal elements. It amounts to integrate out the fast degree of freedom e, which leads to the following averaged Hamiltonian

HN (q, p) = - 1 BN > e-BN HN (q,p,e)) (57)

- In( LE{0,1}N 1

1 = p . Mp + -q . Laq + UN(q).

where Ug (q) denotes the averaged potential

U@(q) = - 1

BN - In( LE{0,1}N e-BNUN (a.e)

and correspondingly, the averaged distribution is given by

T(q, p) xx exp(-BN HN (q, p)).

(58)

We define the conditional probability distribution in ( with fixed (q, p), namely, 1 exp(-BN HN(q, p, e)). (59)

T(l | q, p) = exp(-BNHN(q, p))

and the averaged observable

W[A](q,p) := ETT(e |q,p)WN[A](q,p,l), LE{0,1}N

(60)

20

then the thermal average is approximated by

(A) =/

## dzī(z)W[A](z).



(61)

R2dN

If we can construct a trajectory z(t) that is ergodic with respect to the equilibrium distribution T, we can sample the ensemble average on the right hand side of (61) by a time average to approximate (A):

(A) ~ lim T+00 T 1.

1

0 T WN[A](z(t)) dt. (62)

In [36], the infinite swapping limit of the PIMD-SH method was introduced to sample the thermal average (61), where z(t) evolves according to the following Langevin dynamics

dq = M-1pdt.

(63)

dp = - VaHN (q, p) dt - ypdt + 1 248~1 M dB

(64)

= - Lªqdt - VqUx (q) dt - ypdt + 2B MdB.

We observe that, compared with the single level case, the sampling dynamics only differs in the - VqUg(q) term, and the preconditioning techniques introduced in Section 2.3 can be directly applied. In the following, we only consider the preconditioning for the mass-modified Langevein system.

Similar to the single level case, M is a positive definite fictitious mass matrix for the auxiliary momentum variables p. We choose M = La and introduce the velocity variable v = M-1p, then, we obtain the mass- modified Langevin dynamics

dq = v dt;

dv = - qdt - (La)-1VaUg (q) dt - yv dt

(65)

+ 2~(La)-1 BN - dB. -

And with this change of variables, the Hamiltonian (56) is rewritten as

HN (a, v) = = v . Lav + 29 . Loq + UN(a).

(66)

To conclude this section, we remark that the preconditioning techniques, in theory, are compatible with other numerical approaches in the non-adiabatic regime, e.g. [38, 47]. We shall omit the derivations in this work, and only we will carry out numeric experiments for the preconditioned mass-modified IS method (pmmIS).

## 5 Numerical Tests



## 5.1 BAOAB integrator for Langevin dynamics



For numerical integration of the sampling dynamics, we will use variants of the BAOAB scheme [32] which is widely used for the original Langevin dynamics (Lang). We discuss the adaptations of the BAOAB scheme to the proposed systems.

21

Let us consider a general Langevin dynamics as

dq = C1M-1pdt;

(67)

dp = - C1Laqdt - C1VqUN dt - C2pdt + 1 BN 2yC2M dB,

(68)

where C1 and C2 are some positive definite matrices, and we assume C2 and M commute: C2M = MC2. Obviously, when C1 = C2 = I and M = mI, the system (67)-(68) reduces to (Lang). When C1 = C2 = (La)-1 and M = mI, the system (67)-(68) becomes (pLang). It reduces to (mmLang) when C1 = C2 = I and M = La. The original BAOAB scheme easily extends to the system (pmmLang) in q and v variables, which we will skip the details.

BAOAB scheme is based on operator splitting, where the whole dynamics is divided into the kinetic part (denoted by "A")

dq = C1M-1pdt;

(69)

dp = 0,

(70)

the potential part (denoted by "B")

dq = 0; dp = C1La qdt - C1 VUN (q) - dt

(71)

(72)

and the thermostat part (denoted by "O")

dq = 0;

(73)

dp = - C2pdt + 2C2YBN1MdB.

(74)

Note that, the potential step and the kinetic step can be solved analytically and the thermostat part allows the following exact solution in the sense of distributions

q(t)=q(0); p(t) = e-YC2tp(0) + (1 - e27Czt) (TM) },

(75)

(76)

where § is dN dimensional, with each component an independent standard Gaussian random variable. We also remark that if time step size At is fixed, the matrix e-YCzt and 1 - e27Czt can be precomputed. Thus, in each time evolution step, the computation complexity is dominated by the matrix-vector multiplication.

## 5.2 Numerical examples



To compare the performance of the diagonal-mass Langevin dynamics (Lang), the preconditioned diagonal- mass Langevin dynamics (pLang), the mass-modified Langevin dynamics (mmLang) and the preconditioned mass-modified Langevin dynamics (pmmLang), we carry out numerical tests using the following two ex- amples, in one and two dimension, with computational domain with periodic boundary conditions. The reference solutions are obtained with pseudo-spectral discretization (which is possible thanks to the low- dimensionality). In these examples, a large number of beads are needed to reduce the asymptotic error, and thus manifest differences of the various Langevin dynamics introduced above.

22

In the 1D test problem, the potential function is given by

## V(q) = 10 - 10 cos(q) + 5 cos(2(q-0.1)).



(77)

This potential surface is plotted in Figure 3, from which, we observe that the potential function has two local minima around x = +1 respectively, and the barrier separating the two minima is located around x = 0. We choose inverse temperature 3 = 8 and observable is given by

A(q) = e-10q2

.

(78)

Since the observable is localized around the local maximum of the potential and the prescribed tempera- ture is fairly low compared to the potential barrier, many beads are needed to represent the ring polymer configuration that extending from the local minima to the saddle point.

25

20

15

10

(0.1984, 5.0997)

5

(-0.9816, 1.6513)

0

-3

-2

-1

(1.1184, 3.3822)

0

1

2 3

Figure 3: Potential surface of the 1D test example (77). The red dots mark local maximum and local minima.

In the 2D example, the potential function is given by a three-well model in 2D (see Fig. 5):

V(q1, q2)= 12-3(1+cos(q1))(1+cos(q2))

+ 3e-592-5(q2-0.2)2 - 30-592-5(q2-0.6)2

(79)

- 5e-5(q1-0.6)2-5q2 - 5e-5(q1+0.6)2 -5q2

Around the origin, there are two deeper wells located around (+0.6, 0) and a shallower well located around (0, 0.6). The inverse temperature is given by 6 = 8 and the test observable is a Gaussian located around the shallower well

A(q1, q2) = e-10(g2+(q2-0.6)2)

(80)

Thus a large number of beads are needed to represent the ring polymer configuration.

For the two-level example, the test potential is

Voo=a(1-cos(x));

-

V11=b(1-cos(x));

(81)

V01=V10=ce-dx2

We take b > a, so V11 > Voo and the two energy surfaces only intersect at x = 0, where the off-diagonal term takes its largest value. The energy surfaces are symmetric with respect to x = 0. At thermal equilibrium,

23

1

4

3

0.5

2

1

92

0

0

-1

-0.5

-2

-3

-1

-1

-0.5

0

0.5

1

q

1

Figure 4: Potential surface of the 2D test example (79). At (=0.6, 0), the potential takes the value -3.6317, and at (0, 0.6), the potential takes the value -0.8773.

the density is expected to concentrate around x = 0, where transition between the two surfaces is the most noticeable due to the larger off-diagonal coupling terms. In this work, we choose a = 4, b = 8, c = 1 and d = 1. We plot the diabatic energy surfaces in Figure 5. In this example, we test and compare the performances of numerical methods with the diagonal observable

Â= e-92 0 e-q2 ,

0

(82)

and also the off-diagonal observable

A= 0 e-9 e-q2

.

(83)

0

16

- - Voo

14

-V 11

12

-----. V. 01

10

8

6

4

2

0

-3 -2

-1

0

1

2 3

Figure 5: Diabatic potential surfaces for the test example (81).

24

## 5.3 Stability and convergence tests with different time step sizes



In this section, we focus on the 1D test example, with the potential function and the observable given by (77) and (78), respectively, and we choose the inverse temperature 8 = 8. In the (Lang) system and (pLang) system, we choose the scalar mass m = 1. We first aim to test the four Langevin dynamics (Lang), (pLang), (mmLang) and (pmmLang) using the BAOAB scheme with various time steps and numbers of beads. In particular the time step size restrictions when the number of beads is large. We further study the convergence behavior of the PIMD simulations with respect to the time step size.

We test the BAOAB method with At = 1, 1, 1, 7 and 23. The errors in the empirical averages till simulation time T = 10, 000 from each simulation are reported in Table 1 and Table 2. We observe that, the two preconditioned Langevin dynamics (pLang) and (pmmLang) show superior numerical stability compared to the other two systems, as expected. The numerical results are stable even for At = 1, and they provide accurate approximation of the observable when At < 1.



|# beads|At = 1|△t= =|△t = 16|At = 64 1|△t = 26|
|---|---|---|---|---|---|
|32|NaN|9.74e-2|1.15e-2|1.05e-2|9.67e-3|
|64|NaN|NaN|2.30e-3|3.11e-3|1.31e-3|
|128|NaN|NaN|9.79e-2|3.85e-4|4.03e-4|


# beads

At = 1

At = 7

△t = 16

△t = 24

At = 256 256

32

9.86e-2

1.07e-2

1.22e-2

1.10e-2

7.01e-3

64

9.80e-2

4.10e-3

3.01e-3

3.75e-3

4.69e-3

128

9.87e-2

2.88e-3

2.73e-3

4.70e-4

2.15e-4

Table 1: 1D Example. Numerical empirical averages computed with various time step sizes and various numbers of beads. The reference value is 9.8734e-2. Top: the (Lang) system. Bottom: the (pLang) system. "NaN" means the numerical integrator is unstable.



|# beads|△t=1|At = 1|△t = 16 16|At = = 64|At = 236 1|
|---|---|---|---|---|---|
|32|NaN|NaN|NaN|1.16e-2|9.62e-3|
|64|NaN|NaN|NaN|NaN|2.91e-3|
|128|NaN|NaN|NaN|NaN|NaN|


# beads

At = 1

△t= 2

△t = 금

△t= ↓ : 64

At = 236 = 256

32

9.75e-2

1.03e-2

9.94e-3

1.04e-2

9.09e-3

64

9.84e-2

2.83e-3

3.00e-3

3.21e-3

1.05e-3

128

9.82e-2

1.03e-3

2.48e-4

1.33e-3

4.23e-4

Table 2: 1D Example. Numerical empirical averages computed with various time step sizes and various numbers of beads. The reference value is 9.8734e-2. Top: the (mmLang) system, Bottom: the (pmmLang) system. "NaN" means the numerical integrator is unstable.

In comparison, the numerical solution for (Lang) blow up for large numbers of beads or large time step sizes, caused by instability. The stability constraint is even more severe for (mmLang) We further observe

25

that in the (Lang) system and the (mmLang) system, as the number of beads increases, one needs to take smaller time steps in integration the sampling trajectories for the sake of stability.

Finally, we observe from the tables that, when the number of bead equals 128, the numerical results are closer to the reference values. It confirms the intention of designing such an example, due to the large potential barrier and the low temperature, many beads are needed to reduce the asymptotic error in the ring polymer approximation.

Next, we test the two preconditioned dynamics (pLang) and (pmmLang) for convergence with respect to the time step sizes. To reduce the effect of the asymptotic error in the ring polymer approximation, we take the number of beads N = 128. We test the two systems with At = +, 1, 1 and 1 with simulation time T = 40, 000. We plot the running averages of the PIMD simulation for (pLang) and (pmmLang) in Figure 6. We observe the the plots that, while some estimation bias is present for At = 2, it is becomes not unnoticeable when At takes smaller values.

0.13

At=1/2 At=1/4 At=1/8

0.12

At=1/16

- Reference

0.11

0.13

At=1/2 At=1/4 At=1/8 At=1/16 Reference

0.12

0.11

average

0.1

average

0.1

0.09

0.09

0.08

0.08

0.07

0 0.5

1 1.5

2.5

21

3

3.5

×104

0.07 4

0

0.5 1 1.5

2.5

2 1

3 3.5

4

×104

Figure 6: 1D Example. Running averages of the PIMD method with various time steps. The reference value is 9.8734e-2. Left: the (pLang) system, Right: the (pmmLang) system.

We can further confirm our observation by looking at the mean squared error as a function of sampling time for those two systems as in Figure 7. When At = +, we observe in either case the sampling error is saturated around t = 1,000, and when At = 1 or 1, the sampling error is saturated around t = 10, 000. This implies that when the simulation time is long enough, the bias introduced by numerically integrating the sampling trajectories with large time steps dominates the mean squared error.

The numerical results suggest we can take o(1) time steps for accurate approximation of the ensemble average, even for very large number of beads. From this perspective, the (pLang) system and the (pmmLang) system are better platforms for PIMD simulations, because we only need to take small time steps for accuracy, but not for stability constraints.

## 5.4 Convergence with respect to the number of beads



In this part, we aim to compare the PIMD simulation for the (pLang) system and the (pmmLang) system from another perspective. We take At = 50 to make sure the bias due to numerical integration of the sampling trajectory is negligible when the simulation time T = 10, 000. The mean squared errors for simulating those two systems are plotted in Figure 8. We observe in either test noticeable asymptotic bias when the number of beads is 32 or 64, while the mean squared error decays in inverse proportion to the simulation time when the number of beads equals 128.

26

10-2 THAT

10-3

-0- At=1/2

-0- At=1/4 *At=1/8 + At=1/16

10-3

G

10-4

e- At=1/2 0 At=1/4 * At=1/8 +At=1/16

6

Q

mean squared error

10-4

mean squared error

10-5

10-5

10-6

10-6

102

103

t

10-7 104

105

102

103 104

t

105

Figure 7: 1D Example. Mean squared errors at t = 26, 27, ... , 215 by the BAOAB method with various time step sizes. Left: the (pLang) system. Right: the (pmmLang) system.

10-2

10-3

10-4

mean squared error

10-5

0- pLang, N=32

0- pLang, N=64

* pLang, N=128

10-6

-----. pmmLang, N=32

----- pmmLang, N=64 -**--* pmmLang, N=128

10-7

101 102

103

t

104

Figure 8: 1D Example. Mean squared errors at t = 24, 25, ... , 213 by the BAOAB method with various number of beads. Solid line: the (pLang) system. Dash-dot line: the (pmmLang) system.

Moreover, we can observe some differences between the two systems (pLang) and (pmmLang). By comparing Figure 7, and Figure 8, we find that when the numerical error is dominated by the sample variance (small At and large number of beads), sampling based on (pmmLang) has better accuracy. To understand better this observation, we plot in Figure 9 the autocorrelation of the q variable for the number of beads N = 64, 128 and the time step At = 3. We clearly see that the autocorrelation time of (pmmLang) is much smaller than that of (pLang). Thus (pmmLang) produces more effective independent samples with the same amount of simulation time. This is consistent with the presence of slow modes in (pLang) discussed above; and (pmmLang) dynamics converges to equilibrium faster. We also show in Table 3 the correspondingly empirical error, 95% confidence interval and the mean squared error at simulation time T = 10, 000, which further verify that asymptotic sample variance of the (pmmLang) dynamics is indeed smaller.

From all the tests above, we conclude that the preconditioning as in (pLang) and (pmmLang) improves PIMD sampling, while the (pmmLang) sampling dynamics has superior performance as it reduces further the asymptotic variance.

27

1

pLang, N=64 " pLang, N=128 pmmLang, N=64 pmmLang, N=128

0.8

0.6

autocorrelation

0.4

0.2

0

-0.2 0

5

10

time-lag

15

20

Figure 9: 1D Example. Autocorrelation of the position variables sampled from the (pLang) system and the (pmmLang) system.



||(pLang) dynamics||(pmmLang) dynamics||
|---|---|---|---|---|
||N=64|N=128|N=64|N=128|
|Error|5.23e-3|9.78e-5|3.34e-3|4.02e-4|
|95% C.I.|2.91e-3|2.05e-3|1.44e-3|1.52e-3|
|M.S.E.|2.94e-5|1.10e-6|1.23e-5|7.70e-7|


Table 3: 1D Example. Errors in numerical empirical averages with 95% confidence intervals and mean squared errors. The reference value is 9.8734e-2.

## 5.5 Comparison with the staging PIMD



To compare with the staging PIMD method ([48, 5, 34]), we repeat the 1D test problem with Hamiltonian in the staging coordinate (27). Note that, to compare with the Langevin dynamics and the preconditioned versions proposed in Section 2.3, we also applied the Langevin thermostat to (27) with inverse temperature BN. We remark that, the staging PIMD that we test in the following is different from the one in [48] in terms of thermostatting methods, but is similar to the Langevin dynamics in [34] although they chose the effective inverse temperature 8 instead and they proposed the use of optimal friction coefficient. In the first set of tests below, we stick to the choice the friction constant y = 1. In fact, we have also repeated the tests in the second set, by the staging PIMD with parameters given in [34].

We test the BAOAB method with At = 1, 4, 1, 7 and 23. The errors in the empirical averages till simulation time T = 10, 000 from each simulation are reported in Table 4. We observe that, with the staging coordinates, the numerical simulations are all stable, and the errors are similar to Langevin dynamics in Cartesian coordinates when the time steps are small enough. Notice that, comparing with Table 1 and Table 2, the numerical results seem to suggest that, when BN is small, the staging PIMD needs smaller time steps to show satisfactory accuracy. We also checked autocorrelation of the position variables, which are mapped from the staging variables, and the autocorrelation show smaller scaled oscillations as the number of beads increases, as shown in Figure 10. This observation seems to agree with the multi-scale behaviors of the staging PIMD dynamics as BN << 1. We admit the the staging PIMD algorithm we test above is not optimized due to the freedom of specifying parameters.

Recently, the authors in [34] proposed an optimized version of the staging PIMD. We also tested the

28

problem with the setup in [34] and we observe that the numerical performances (in Table 5 and Figure 10) are improved for some cases. Comparing Table 4 and Table 5, when the beads number is large, the time steps in the latter case which are needed to obtain accurate approximations are less restricted. To sum up, the numerical tests seem to suggest that the Langevin dynamics in staging coordinates exhibit improved stability conditions and show comparable accuracy with the Langevin dynamics in Catesian coordinate when time steps are sufficiently resolved. Among all the sampling dynamics that we have tested, the (pLang) system and the (pmmLang) system are still favored because they both give the most relaxed constraints for the time steps to produce accurate simulation results, and the (pmmLang) system is slightly superior as shown in the tests above. For example, when At = 1, both the (pLang) system and the (pmmLang) system already give relative errors around or lower than 10%, but in this case, the relative errors by staging PIMD are still beyond 50%. On the other hand, when the At is chosen small enough, the numerical performance of the staging PIMD and the two preconditioned versions proposed are rather similar.



|# beads|At = 1|At = 1|△t=To 1|At = 64 1|At = 1 256|
|---|---|---|---|---|---|
|32|4.90e-2|5.22e-2|2.61e-2|1.12e-2|9.57e-3|
|64|5.93e-2|5.99e-2|7.29e-2|4.45e-3|2.55e-3|
|128|6.91e-2|6.92e-2|8.39e-2|6.26e-2|1.96e-4|


Table 4: 1D Example. Numerical empirical averages computed with various time step sizes and various numbers of beads. The reference value is 9.8734e-2. Sampling is obtained by the Langevin dynamics with staging coordinates.



|# beads|△t= 1|△t= 금|At = 16|△t = 2|At = 256|
|---|---|---|---|---|---|
|32|4.85e-2|9.17e-2|9.88e-3|9.93e-3|9.10e-3|
|64|9.57e-2|7.29e-2|4.02e-3|2.46e-3|1.51e-3|
|128|9.48e-2|9.65e-2|1.23e-3|6.16e-4|5.84e-4|


Table 5: 1D Example. Staging PIMD with the setup [34]. Numerical empirical averages computed with various time step sizes and various numbers of beads. The reference value is 9.8734e-2. Sampling is obtained by the Langevin dynamics with staging coordinates.

29

1

1

1

1

N=16

N=32

N=16

N=32

0.5

0.5

0.5

0.5

0

0

0

0

-0.5

0

5 10 15

-0.5 20

0 5 10

15 20

-0.5 0

5 10

15 20

-0.5

0

5

10

15 20

1

1

1

1

N=64

0.5

0

5

N=128

0.5

0

-0.5

N=64

0.5

0

N=128

0.5

0

-0.5 0 5 10

15 20

-1

0 5

10

15 20

-0.5

0

5 10

15 20

-0.5

0 5 10

15 20

Figure 10: 1D Example. Autocorrelation of the position variables sampled from the Langevin system in staging coordinates. Left: Staging PIMD with the friction constant y = 1. Right: Staging PIMD with the setup in [34].

## 5.6 Tests with the 2D example



We now consider the 2D test example, with the potential function and the observable given by (79) and (80), respectively, and the inverse temperature 8 = 8.

We only test the preconditioned dynamics (pLang) and (pmmLang), they have improved numerical stability. To study the performance of the BAOAB method applied to the two preconditioned systems, we take the number of beads N = 128, which makes the asymptotic error in the ring polymer approximation negligible. We test the BAOAB scheme for the two dynamics with time step sizes At = 2, 4, } and 1 and simulation time T = 40, 000. We plot the the mean squared errors at different times in Figure 11. When At = 2, we observe for either system the sampling error is saturated around t = 1, 000, and when At = > or }, the sampling error is saturated around t = 10, 000. This implies that when the simulation time is long enough, the bias introduced by numerically integrating the sampling trajectories with large time steps dominates the mean squared error. Similar to the 1D tests, the numerical results suggest we can take o(1) time steps for accurate approximation of the ensemble average, even for very large numbers of beads.

Next, we compare the PIMD simulation for (pLang) and the (pmmLang) for different numbers of beads. We take At = 30 to make sure the bias due to numerical integration of the sampling trajectory is negligible when the simulation time T = 10, 000. The mean squared errors for the two sampling dynamics are plotted in Figure 12. We observe in either test noticeable asymptotic error when the number of beads is 32 or 64, while large number of beads reduces the error.

Finally, we compare the accuracy of PIMD simulations using (pLang) and (pmmLang) dynamics. By comparing Figure 11 and Figure 12, we observe that when the numerical error is dominated by the sample variance (small At and large number of beads), the (pmmLang) dynamics gives better accuracy in terms of the mean squared error. The autocorrelation time for the q variable plotted in Figure 13 is similar to the 1D case, which indicates that (pmmLang) has better sampling efficiency. This is also further confirmed by Table 6 which present empirical error, 95% confidence interval and the mean squared error at simulation time T = 10,000.

30

10-3

THỊ

10-4 TTT

10-4

:selected:

:selected:

-0- At=1/2 0- At=1/4 * At=1/8 + At=1/16

e- At=1/2 0- At=1/4 -* At=1/8 + At=1/16

10-5

10-5

mean squared error

mean squared error

10-6

: 10-6

10-7

10-7

102

103

104

t

10-8

102

103

104

t

Figure 11: 2D Example. Mean squared errors at t = 26, 27, ... , 215 by the BAOAB method with various time step sizes. Left: the (pLang) dynamics. Right: the (pmmLang) dynamics.

10-2

10-4

0.

mean squared error

- pLang, N=32

10-6

+ pLang, N=64

* pLang, N=128

-----. pmmLang, N=32 + pmmLang, N=64 -*-- pmmLang, N=128

10-8

101

102

103

t

104

Figure 12: 2D Example. Mean squared errors at t = 24, 25, ... , 213 by the BAOAB method with various number of beads. Solid line: the (pLang) system. Dash-dot line: the (pmmLang) system.

## 5.7 Tests with the two-level system



In this part, we implement the preconditioned sampling dynamics, pmmIS, for the two-level quantum system (81) with two sets of observables (82) and (83). The numerical results are compared with those sampled by the direct simulation of the PIMS-SH method and its infinite swapping limit, which we abbreviate by "DS" and "IS", respectively. We choose the inverse temperature 3 = 4. We test the BAOAB method with At = 1, 1 1 and 256 for the three sampling systems. The errors in the empirical averages till simulation time T = 10, 000 from each simulation are reported in Table 7. 4 , 1

In [37, 36], the authors have shown that the DS method give satisfactory performances for the diagonal observables, but requires smaller time steps in integrating the sampling trajectories for the off-diagonal observables, while numerical simulation based on its infinite swapping limit allows large time steps for all the observables with some reasonable increase in the computational cost.

The numerical results based on the DS method in Table 7 agree with the previous understanding of the method. Moreover, we observe that, similar to the single level cases, both the DS method and the IS method are unstable for big time steps when the number of beads is large. When the time steps are sufficiently small, the IS simulations show better accuracy for the off-diagonal observables than the DS simulations.

31

1

pLang, N=64 "pLang, N=128 "pmmLang, N=64

0.8

pmmLang, N=128

0.6

autocorrelation

0.4

0.2

0

-0.2 0

5

10

time-lag

15

20

Figure 13: 2D Example. Autocorrelation of the position variables sampled from the (pLang) system and the (pmmLang) system.



||(pLang) dynamics||(pmmLang) dynamics||
|---|---|---|---|---|
||N=64|N=128|N=64|N=128|
|Error|1.08e-3|5.64e-4|1.38e-3|7.70e-5|
|95% C.I.|9.71e-4|8.79e-4|6.78e-3|5.53e-4|
|M.S.E.|1.42e-6|5.19e-7|1.39e-7|9.28e-8|


Table 6: 2D Example. Errors in numerical empirical averages with 95 % confidence intervals and mean squared errors. The reference value is -0.0888156.

Simulations by pmmIS exhibit improved stability and satisfactory accuracy for the observables, and in particular, the Table 7 show that when At = - , pmmIS already gives very good approximations of the thermal averages for both diagonal and off-diagonal observables. The numerical results clearly verify that the pmmIS simulations show great accuracy for fairly large time steps.

## 6 Conclusion



We have introduced two preconditioned Langevin sampling dynamics for path-integral molecular dynamics, which are in particular effective when the number of beads is large. The forcing from the stiff spring potential between beads is replaced by a linear damping term, which allows large time steps for numerically integration. In terms of the normal modes representation, the mapped modes in the preconditioned Langevin approach has a uniform upper bound in frequency while the mapped slow modes may take longer time for sampling. The mapped modes in the preconditioned mass-modified Langevin sampling all have the same frequency 1, and the corresponding Langevin dynamics has a natural connection to the continuum limit as the number of beads goes to infinity. The numerical tests validate the improved stability and better sampling accuracy for both preconditioned Langevin sampling dynamics for thermal averages.

32



|# beads|At = 1|At = 1|At = 16|△t = 금|△t = 16|
|---|---|---|---|---|---|
|(DS) 32|NaN|NaN|8.51e-3|6.71e-3|4.55e-3|
|(DS) 64|NaN|NaN|5.59e-1|6.28e-3|4.11e-3|
|(IS) 32|NaN|NaN|1.39e-3|1.18e-3|1.38e-3|
|(IS) 64|NaN|NaN|8.39e-1|1.66e-3|1.67e-4|
|(pmmIS) 32|2.38e-1|2.62e-3|3.38e-3|3.22e-3|1.03e-3|
|(pmmIS) 64|2.33e-1|1.22e-3|1.80e-3|1.63e-3|2.20e-5|


# beads

△t=1

At = 1

△t = 금

△t = 김

△t= 0 1 256

(DS) 32

NaN

NaN

2.93e-2

1.52e-2

1.17e-2

(DS) 64

NaN

NaN

6.78e-1

2.62e-2

3.29e-2

(IS) 32

NaN

NaN

2.46e-3

1.62e-3

6.95e-4

(IS) 64

NaN

NaN

8.16e-1

5.01e-4

1.09e-3

(pmmIS) 32

3.07e-1

2.71e-3

2.51e-3

1.12e-3

2.02e-3

(pmmIS) 64

3.10e-1

6.62e-3

4.12e-3

4.72e-4

9.90e-4

Table 7: Two-level Example. Numerical empirical averages computed with various time step sizes and various numbers of beads. Top: the diagonal observable. The reference value is 8.2234e-1. Bottom: the off-diagonal observable. The reference value is -8.1785e-1. "NaN" means the numerical integrator is unstable.

## Acknowledgments



The work of J.L. is partially supported by the National Science Foundation under grant DMS-1454939. The work of Z.Z. is partially supported by a start-up fund from Peking University and NSFC 11801016. We thank Jian Liu for useful discussions.

## A The covariance operator and its finite dimensional approxima- tion



The precondition schemes we proposed rely on the covariance operator @* = (Sa)-1 and its finite dimen- sional approximation (La)-1. In this appendix, we we derive the explicit expression for @ª, and discuss its discretizations.

To explicitly calculate the covariance operator @", we solve for the covariance function Co(T, T') such that the covariance operator is the integral operator with C(T, T') as its kernel, i.e.

0 eaf (+) = | Cª(T, T')f(+') dr', TE [0, 3]. (84)

The covariance function satisfies the following boundary value problem, for T, T' E [0, 3],

SªCa(T,T') = §(T-7'); (85) Ca(0,7')= Cª(B,7'), (86) C+(0, 7') = CC (B, 7'). (87)

33

We show in the following the covariance operator as in (84) indeed gives the inverse of the Sa operator. For f(T) and g(T) satisfying the periodic boundary conditions, by Green's formula, we can easily show that 0 to f (T) 20 g (T) - g (T) [ f (T) dT = 0.

Now we take g(T) = C"(T,T'), then Sag(T) = {(T-T'), then we have

(7) - 1 (, )8ª,

Since it can be shown that Ca(T, T') is symmetric, we thus obtain

f = para f.

This verifies @a = (§ª)-1.

Let us write down the explicit expression when d = 1 and a = 1. The extension to general cases is straightforward. By solving the boundary value problem (85)-(87), we get

- 2(e8-1)

CH (T,T') = { 2(1-e- B ) e+1 -T

+ 2(1-e-B), eT-T' 0 <<<< < B, (88)

ET -T + 2 (eB -1) , ET-T' 0 << < < < B.

In a more compact form, we can write

C1 (T, T') = elT-T'1 2(e8 - 1) + 2(1 - e-B) e-IT-T'| .

From this, we see clearly, the covariance function is symmetric and is a function of IT - T'|.

Next, we discuss two types of finite dimensional approximation of the covariance operator, where the first one is based on the analytical expression of the covariance function and the second one is based on the inverse of the finite dimensional approximation of Sa.

If we denote the equidistant grid points in T by T = Si, i = 1, ... , N, and evaluate the covariance function at those grid points, we obtain the numerical approximation of the covariance operator @1, which is denoted by Cy. Namely, given a function g : [0, 3] > R and we denote its confinement on the grids {Ti} by g, then we have

N

CNg = XCH (Ti, Tj) g (Tj) BN.

j=1

With a bit abuse of notations, we can also view Cy as a matrix, such that (CN) ¡ = C1 (Ti, Tj) BN.

However, this approximate covariance is not exactly the inverse of L1 as in (8) on the same grids, since La is only a finite difference approximation to the continuous counterpart as in (9).

An alternative way is to directly take the inverse of the finite dimensional approximation of §1 on the grid points. Consider the equidistant grid points {Ti}, we observe the finite difference approximation of the covariance operator 21 is exactly L1 (viewed as a linear transform) defined as in (8). Clearly, L1 is strictly positive definite, and is thus invertible. We will use this approach to precondition finite dimensional systems.

34

## B Invariance measure in finite dimensional cases



In this section, we aim to verify that the finite dimensional Langevin dynamics, (Lang), (pLang) and (mmLang) all take TIN (q, p) as their invariant measures (although the choices of the mass matrix are differ- ent), and (pmmLang) takes the invariance measure IN (q, v).

Note that, albeit various choices of the mass matrices, in general TIN (q, p) is given by

TN(q,p) x exp ( -BN (59 . Loq + UN + p . M-1p).

.

(89)

We consider the Langevin dynamics as defined in (67) and (68), which covers the systems (Lang), (pLang) and (mmLang).

The Fokker-Planck equation corresponding to (67) and (68) reads

at Af + CM-1p . Vaf + ((-CL)q - C\UN) . Vpf = p . (C2(pf + Vpf) ) . BN M

(90)

Here, we have used the fact that

ij 2: (C2M) = >api Opj (C2M) ji = > api (C2M)jidpj = Vp . (C2MVp). ij

Hence, we can easily see that, (89) is an steady state to this Fokker-Planck equation. Therefore, (Lang), (pLang) and (mmLang) all have invariant measures as in (89). We also conclude that the preconditioning with C1 and C2 does not change the invariant measure.

In particular, in (pLang), the Fokker-Planck equation takes the following form

off+(La)-1-p.Vaf+(-9-(La)-1\UN) · Vpf = p. (La)-1 (pf + mpf).

We observe that, the most stiff part of the original equation -Laq is replaced by -q due to the precondi- tioning.

For the (pmmLang) system, we have the phase space distribution in (q, v) variables,

IN (q, v) x= exp ( -BN (=v . Lav + 9. La + UN)

.

(91)

Clearly, the Fokker-Planck equation corresponding to (pmmLang) as in (pmmLang) is given by

f+ (La)- pf

.

(92)

of + v . Vaf - (q + (La)-1VqUN) . Vuf = WVp . | pf + BN (La)-1

We can rewrite this equation as

of + (La)-1Lav . Vaf - (La) -1 (Laq + VqUN) . Vuf = p . (pf +4

(La)-1 BN -Vpf).

Therefore, we can verify that the (pmmLang) system (pmmLang) takes (91) as its invariant measure. Finally, we observe that, similar to the Fokker-Planck equation for (pLang), (92) also includes the term -q in place of the stiff term -Laq, but the rest of the terms are different.

35

## C Ring polymer representation for two-level quantum systems



In this part, we present the details of the ring polymer representation of thermal averages as in (53) for two- level quantum systems, which have been rigorously derived in [37]. With the diabatic basis, we approximate the partition function by a ring polymer representation with N beads

Trnele-BH ~ ZN =

1

(27)dN

IR2ªN dq dp x LE{0,1}N > exp(-BN HN(q, p, e)),

where BN = B/N. The ring polymer that consists of N beads is prescribed by the configuration (q, p, l) E RAN x RdN ×{0,1}N.

For a given ring polymer with configuration (q, p, e), the effective Hamiltonian HN (q, p, e) is given by

HN(q, p, l) = p . M-1p+ >{k |Sk |(k+1), k=1 N where we take the convention that (N+1 = (1 and matrix elements of Sk, k = 1, ... , N, are given by

(93)

M (qk - qk+1)2 + V00(qk) + V11(qk) BN 1 In (sinh (BN | Vo1(qk)| , −

{\Skle') =

2(BN)2 2

for & # l', and the diagonal terms are given as

2 2(BN)2

(e)Skall) = M (qk - qk+1) + Vee(qk) - BN 1 - In (cosh(BN |Vo1(qk)|) ),

where we have suppressed the q and p dependence in the notation of Sk. Here Sk can be understood as the the contribution of (qk |e-BNH |qk+1) to the effective Hamiltonian HN in the ring polymer representation. The readers may refer to [37] for the derivations.

For an observable A, under the ring polymer representation, we have

Trne[e-BH Â~ 1 (2Tr) dN İR2ªN

dq dp lE{0,1}N L x exp(-BN HN) WN [A], (95)

where the weight function associated to the observable is given by (recall that A only depends on position by our assumption)

N I ( Kl k | A ( k ) ( k ) - ( BN ( ek Sklk+1) -BN {k|Sklk+1) (lk|A(dk) [k)

1 N k=1

WN[A](q, p, l) = -

IVen k Venta). , (96)

where we have introduced the short hand notation tk = 1 -lk, i.e., Ik is the level index of the other potential energy surface than the one corresponds to lk in our two-level case. Similar as for the partition function, the ring polymer representation (95) replaces the quantum thermal average by an average over ring polymer configurations on the extended phase space RdN x RdN × {0,1}N.

The ring polymer representation for a multi-level quantum system can be also constructed using the adiabatic basis [44, 37], and much of the current work also extends to the ring polymer with the adiabatic basis. We will skip the details and leave to interested readers.

## References



[1] B.J. Berne and D. Thirumalai. On the simulation of quantum systems: path integral methods. Ann. Rev. Phys. Chem., 37:401-424, 1986.

36

[2] A. Beskos, F.J. Pinski, J.M. Sanz-Serna, and A.M. Stuart. Hybrid Monte Carlo on Hilbert spaces. Stoch. Process. Their Appl., 121(10):2201-2230, 2011.

[3] A. Beskos, G. Roberts, A. Stuart, and J. Voss. Mcmc methods for diffusion bridges. Stoch. Dyn., 8(3):319-350, 2008.

[4] Alexandros Beskos, Mark Girolami, Shiwei Lan, Patrick E Farrell, and Andrew M Stuart. Geometric mcmc for infinite-dimensional inverse problems. Journal of Computational Physics, 335:327-351, 2017.

[5] J. Cao and G.J. Martyna. Adiabatic path integral molecular dynamics methods. ii. algorithms. J. Chem. Phys., 104:2028-2035, 1996.

[6] J. Cao and G.A. Voth. The formulation of quantum statistical mechanics based on the Feynman path centroid density. I. Dynamical properties. J. Chem. Phys., 100:5106-5117, 1994.

[7] J. Cao and G.A. Voth. The formulation of quantum statistical mechanics based on the Feynman path centroid density. I. Equilibrium properties. J. Chem. Phys., 100:5093-5105, 1994.

[8] M. Ceriotti, G. Bussi, and M. Parrinello. Nuclear quantum effects in solids using a colored-noise thermostat. Phys. Rev. Lett., 103(3):030603, 2009.

[9] M. Ceriotti, D. E. Manolopoulos, and M. Parrinello. Accelerating the convergence of path integral dynamics with a generalized langevin equation. J. Chem. Phys., 134:084104, 2011.

[10] M. Ceriotti, M. Parrinello, T. E. Markland, and D. E. Manolopoulos. Efficient stochastic thermostatting of path integral molecular dynamics. J. Chem. Phys., 133(12):124104, 2010.

[11] M. Ceriotti, M. Parrinello, T.E. Markland, and D.E. Manolopoulos. Accelerating the convergence of path integral dynamics with a generalized langevin equation. J. Chem. Phys., 133:124104, 2010.

[12] D. Chandler and P.G. Wolynes. Exploiting the isomorphism between quantum theory and classical statistical mechancis of polyatomic fluids. J. Chem. Phys., 74:4078-4095, 1981.

[13] Simon L Cotter, Gareth O Roberts, Andrew M Stuart, and David White. Mcmc methods for functions: modifying old algorithms to make them faster. Statistical Science, pages 424-446, 2013.

[14] I. R. Craig and D. E. Manolopoulos. Quantum statistics and classical mechanics: Real time corrleation functions from ring polymer molecular dynamics. J. Chem. Phys., 121:3368, 2004.

[15] I.R. Craig and D.E. Manolopoulos. Quantum statistics and classical mechanics: Real time correlation functions from ring polymer molecular dynamics. J. Chem. Phys., 121:3368-3373, 2004.

[16] G. Da Prato and J. Zabczyk. Ergodicity for infinite dimensional systems (Vol. 229). Cambridge University Press, 1996.

[17] A. Eberle. Error bounds for metropolis-hastings algorithms applied to perturbations of gaussian mea- sures in high dimensions. Ann. Appl. Probab., 24(1):337-377, 2014.

[18] A. Eberle, A. Guillin, and R. Zimmer. Couplings and quantitative contraction rates for langevin dy- namics. Ann. Probab., 47(4):1982-2010, 2019.

[19] R.P. Feynman. Statistical Mechanics. Addison-Wesley, Reading, MA, 1972.

37

[20] D.L. Freeman and J.D. Doll. A monte carlo method for quantum boltzmann statistical mechanics using fourier representations of path integrals. J. Chem. Phys., 80:5709-5718, 1984.

[21] S. Habershon, D. E. Manolopoulos, T.E. Markland, and T.F. Miller III. Ring-polymer molecular dy- namics: quantum effects in chemical dynamics from classical trajectories in an extended phase space. Annu. Rev. Phys. Chem., 64, 2013.

[22] M. Hairer. The motion of a random string, 2016. preprint, arXiv:1605.02192.

[23] M. Hairer, A.M. Stuart, and S.J. Vollmer. Spectral gaps for a metropolis-hastings algorithm in infinite dimensions. Ann. Appl. Probab., 24(6):2455-2490, 2014.

[24] M. Hairer, A.M. Stuart, and J. Voss. Analysis of spdes arising in path sampling part ii: The nonlinear case. Ann. Appl. Probab., 17(5/6):1657-1706, 2007.

[25] M. Hairer, A.M. Stuart, J. Voss, and P. Wiberg. Analysis of spdes arising in path sampling. part i: The gaussian case. Commun. Math. Sci., 3(4):587-603, 2005.

[26] T.J.H. Hele, M.J. Willatt, A. Muolo, and S.C. Althorpe. Boltzmann-conserving classical dynamics in quantum time-correlation functions: "Matsubara dynamics". J. Chem. Phys., 142:134103, 2015.

[27] T.J.H. Hele, M.J. Willatt, A. Muolo, and S.C. Althorpe. Communication: Relation of centroid molec- ular dynamics and ring-polymer molecular dynamics to exact quantum dynamics. J. Chem. Phys., 142:191101, 2015.

[28] S. Jang and G. A. Voth. A derivation of centroid molecular dynamics and other approximate time evolution methods for path integral centroid variables. J. Chem. Phys., 111:2371, 1999.

[29] R. Kapral. Progress in the theory of mixed quantum-classical dynamics. Annu. Rev. Phys. Chem., 57:129-157, 2006.

[30] R. Korol, N. Bou-Rabee, and T.F. Miller III. Dimension-free path-integral molecular dynamics without preconditioning. 2019. preprint, arXiv:1911.00931.

[31] Shiwei Lan. Adaptive dimension reduction to accelerate infinite-dimensional geometric markov chain monte carlo. Journal of Computational Physics, 392:71-95, 2019.

[32] B. Leimkuhler and C. Matthews. Robust and efficient configurational molecular sampling via Langevin dynamics. J. Chem. Phys., 138(17):174102, 2013.

[33] J. Liu. Path integral Liouville dynamics for thermal equilibrium systems. J. Chem. Phys., 140(22):224107, 2014.

[34] J. Liu, D. Li, and X. Liu. A simple and accurate algorithm for path integral molecular dynamics with the Langevin thermostat. J. Chem. Phys., 145:024103, 2016.

[35] J. Liu and Z. Zhang. Path integral Liouville dynamics: Applications to infrared spectra of OH, water, ammonia, and methane. J. Chem. Phys., 144(3):034307, 2016.

[36] J. Lu and Z. Zhou. Accelerated sampling by infinite swapping of path integral molecular dynamics with surface hopping. J. Chem. Phys., 148(6):4110, 2017.

38

[37] J. Lu and Z. Zhou. Path integral molecular dynamics with surface hopping for thermal equilibrium sampling of nonadiabatic systems. J. Chem. Phys., 146(15):4110, 2017.

[38] J. Lu and Z. Zhou. Path integral molecular dynamics for exact quantum statistics of multi-electronic- state systems. J. Chem. Phys., 148(10):2319, 2018.

[39] N. Makri. Time-dependent quantum methods for large systems. Annu. Rev. Phys. Chem., 50:167-191, 1999.

[40] T. E. Markland and D. E. Manolopoulos. An efficient ring polymer contraction scheme for imaginary time path integral simulations. J. Chem. Phys., 129(2):024105, 2008.

[41] T. Matsubara. A new approach to quantum-statistical mechanics. Prog. Theor. Phys., 14(4):351-378, 1955.

[42] H .- D. Meyer and W.H. Miller. A classical analog for electronic degrees of freedom in nonadiabatic collision processes. J. Chem. Phys., 70:3214-3223, 1979.

[43] Michela Ottobre, Natesh S Pillai, Frank J Pinski, Andrew M Stuart, et al. A function space hmc algorithm with second order langevin diffusion limit. Bernoulli, 22(1):60-106, 2016.

[44] J. R. Schmidt and J. C. Tully. Path-integral simulations beyond the adiabatic approximation. J. Chem. Phys., 127(9):094103, 2007.

[45] G. Stock and M. Thoss. Semiclassical description of nonadiabatic quantum dynamics. Phys. Rev. Lett., 78(4):578, 1997.

[46] G. Stock and M. Thoss. Classical description of nonadiabatic quantum dynamics. Adv. Chem. Phys., 131:243-376, 2005.

[47] X. Tao, P. Shushkov, and T.F. Miller III. Path-integral isomorphic hamiltonian for including nuclear quantum effects in non-adiabatic dynamics. J. Chem. Phys., 148(10):102327, 2018.

[48] M.E. Tuckerman, B.J. Berne, G.J. Martyna, and M.L. Klein. Efficient molecular dynamics and hybrid monte carlo algorithms for path integrals. J. Chem. Phys., 99:2796-2808, 1993.

[49] R. Zimmer. Explicit contraction rates for a class of degenerate and infinite-dimensional diffusions. Stoch. Partial Differ. Equ. Anal. Comput., 5(3):368-399, 2017.

39

